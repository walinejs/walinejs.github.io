import{g as P,j as T,N as U,o as x,c as j,b as g,t as A,u as k,y as $,O as H,z as Q,d as R,P as B,Q as W}from"./app-B4QLYwU8.js";import{m as Z}from"./marked.esm-BF5RVfHd.js";import{_ as G}from"./plugin-vue_export-helper-DlAUqK2U.js";const K=t=>{const s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(s)},X=(t,s)=>{const f=window.URL||window.webkitURL||window,l=new Blob([s]),u=document.createElementNS("http://www.w3.org/1999/xhtml","a");u.href=f.createObjectURL(l),u.download=t,K(u)},Y=t=>{const s=document.createElement("a");return s.href=t,s.pathname||t},C=t=>{t=JSON.parse(t);const s={},f={};for(let l=0;l<t.length;l++)s[t[l].id]=t[l].rid;for(let l=0;l<t.length;l++){if(!t[l].rid)continue;let u=t[l].rid;for(;s[u];)u=s[u];f[t[l].id]=u}return{results:t.map(({content:l,date:u,created_at:d,email:e,id:r,ip:i,link:a,nick:n,page_key:o,rid:c,ua:p,is_pinned:h,is_pending:b,vote_down:v,vote_up:m})=>{const w=u||d?new Date((u||d).replace(/-/g,"/")).toISOString():"",y=Y(o);return{objectId:r,comment:Z.parse(l),insertedAt:{__type:"Date",iso:w},mail:e,createdAt:w,updatedAt:w,ip:i,link:a,nick:n,ua:p,url:y,pid:c||null,rid:f[r]||null,status:b!=="false"?"waiting":"approved",sticky:h==="true",like:m&&v?m-v:0}})}},I=t=>{const s=JSON.parse(t),{comments:f}=s,l={},u={},d={};return Array.isArray(s.commenters)&&s.commenters.forEach(e=>{l[e.commenterHex]={nick:e.name,mail:e.email,link:e.link!=="undefined"?e.link:void 0}}),f.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{u[e.commentHex]=e.parentHex}),f.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{let r=e.parentHex;for(;u[r];)r=u[r];d[e.commentHex]=r}),{results:f.filter(({deleted:e})=>!e).map(({commentHex:e,commenterHex:r,parentHex:i,creationDate:a,html:n,markdown:o,url:c,state:p})=>{const h=l[r]||{nick:"Anonymous",mail:"",link:""};return Object.assign({objectId:e,comment:n||o,insertedAt:{__type:"Date",iso:a},createdAt:a,updatedAt:a,ip:"",ua:"",url:c,pid:i!=="root"?i:"",rid:d[e]?d[e]:"",status:p==="approved"?"approved":"waiting"},h)})}},L=t=>{const f=new DOMParser().parseFromString(t,"application/xml"),l=Array.from(f.querySelectorAll("post")).filter(a=>{var o;const n=a.querySelector("isDeleted");return!(n&&((o=n.textContent)==null?void 0:o.toLocaleLowerCase())==="true")}),u=Array.from(f.querySelectorAll("disqus > thread")),d={};u.forEach(a=>{const n=a.querySelector("link"),o=a.getAttribute("dsq:id");if(d[o]="",n&&n.textContent){const c=new URL(n.textContent);d[o]=c.pathname}});const e={};l.forEach(a=>{const n=a.getAttribute("dsq:id"),o=a.querySelector("parent");if(o){const c=o.getAttribute("dsq:id");if(!c)return;e[n]=c}});const r={};return l.filter(a=>a.querySelector("parent")).forEach(a=>{var c;const n=a.getAttribute("dsq:id");let o=(c=a.querySelector("parent"))==null?void 0:c.getAttribute("dsq:id");for(;e[o];)o=e[o];r[n]=o}),{results:l.map(a=>{var D,N,V,z,E,F;const n=a.getAttribute("dsq:id"),o=(D=a.querySelector("message"))==null?void 0:D.textContent,c=new Date((N=a.querySelector("createdAt"))==null?void 0:N.textContent).toISOString(),p=(V=a.querySelector("author name"))==null?void 0:V.textContent,h=(z=a.querySelector("thread"))==null?void 0:z.getAttribute("dsq:id"),b=d[h],v=a.querySelector("parent"),m=v?v.getAttribute("dsq:id"):null,w=v?r[n]:null,y=((F=(E=a.querySelector("isSpam"))==null?void 0:E.textContent)==null?void 0:F.toLowerCase())!=="false";return{objectId:n,comment:o,insertedAt:{__type:"Date",iso:c},createdAt:c,updatedAt:c,ip:"",link:"",mail:"",nick:p,ua:"",url:b,pid:m,rid:w,status:y?"spam":"approved"}})}};var J={};(function(t){t.__type__="csv";var s=typeof jQuery<"u"&&jQuery.Deferred||typeof _<"u"&&_.Deferred||function(){var e,r,i=new Promise(function(a,n){e=a,r=n});return{resolve:e,reject:r,promise:function(){return i}}};t.fetch=function(e){var r=new s;if(e.file){var i=new FileReader,a=e.encoding||"UTF-8";i.onload=function(o){var c=t.extractFields(t.parse(o.target.result,e),e);c.useMemoryStore=!0,c.metadata={filename:e.file.name},r.resolve(c)},i.onerror=function(o){r.reject({error:{message:"Failed to load file. Code: "+o.target.error.code}})},i.readAsText(e.file,a)}else if(e.data){var n=t.extractFields(t.parse(e.data,e),e);n.useMemoryStore=!0,r.resolve(n)}else e.url&&(window.fetch||function(o){var c=jQuery.get(o),p={then:function(h){return c.done(h),p},catch:function(h){return c.fail(h),p}};return p})(e.url).then(function(o){return o.text?o.text():o}).then(function(o){var c=t.extractFields(t.parse(o,e),e);c.useMemoryStore=!0,r.resolve(c)}).catch(function(o,c){r.reject({error:{message:"Failed to load file. "+o.statusText+". Code: "+o.status,request:o}})});return r.promise()},t.extractFields=function(e,r){return r.noHeaderRow!==!0&&0<e.length?{fields:e[0],records:e.slice(1)}:{records:e}},t.normalizeDialectOptions=function(e){var r={delimiter:",",doublequote:!0,lineterminator:`
`,quotechar:'"',skipinitialspace:!0,skipinitialrows:0};for(var i in e)i==="trim"?r.skipinitialspace=e.trim:r[i.toLowerCase()]=e[i];return r},t.parse=function(e,r){r&&(!r||r.lineterminator)||(e=t.normalizeLineTerminator(e,r));var i,a,n=t.normalizeDialectOptions(r);i=e,a=n.lineterminator,e=i.charAt(i.length-a.length)!==a?i:i.substring(0,i.length-a.length);var o,c,p="",h=!1,b=!1,v="",m=[],w=[];for(c=function(y){return b!==!0&&(y===""?y=null:n.skipinitialspace===!0&&(y=d(y)),f.test(y)?y=parseInt(y,10):l.test(y)&&(y=parseFloat(y,10))),y},o=0;o<e.length;o+=1)p=e.charAt(o),h!==!1||p!==n.delimiter&&p!==n.lineterminator?p!==n.quotechar?v+=p:h?e.charAt(o+1)===n.quotechar?(v+=n.quotechar,o+=1):h=!1:b=h=!0:(v=c(v),m.push(v),p===n.lineterminator&&(w.push(m),m=[]),v="",b=!1);return v=c(v),m.push(v),w.push(m),n.skipinitialrows&&(w=w.slice(n.skipinitialrows)),w},t.normalizeLineTerminator=function(e,r){return(r=r||{}).lineterminator?e:e.replace(/(\r\n|\n|\r)/gm,`
`)},t.objectToArray=function(e){for(var r=[],i=[],a=[],n=0;n<e.fields.length;n++){var o=e.fields[n].id;a.push(o);var c=e.fields[n].label?e.fields[n].label:o;i.push(c)}for(r.push(i),n=0;n<e.records.length;n++){for(var p=[],h=e.records[n],b=0;b<a.length;b++)p.push(h[a[b]]);r.push(p)}return r},t.serialize=function(e,r){var i=null;i=e instanceof Array?e:t.objectToArray(e);var a,n,o,c=t.normalizeDialectOptions(r),p="",h="",b="",v="";for(o=function(m){return m===null?m="":typeof m=="string"&&u.test(m)?(c.doublequote&&(m=m.replace(/"/g,'""')),m=c.quotechar+m+c.quotechar):typeof m=="number"&&(m=m.toString(10)),m},a=0;a<i.length;a+=1)for(p=i[a],n=0;n<p.length;n+=1)h=o(p[n]),n===p.length-1?(v+=(b+=h)+c.lineterminator,b=""):b+=h+c.delimiter,h="";return v};var f=/^\d+$/,l=/^\d*\.\d+$|^\d+\.\d*$/,u=/^\s|\s$|,|"|\n/,d=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}})(J);const S=t=>{const s=["id","nick","updatedAt","mail","ua","ip","status","insertedAt","createdAt","comment","pid","rid","link","url","user_id"],f={},l=r=>{if(r.hasOwnProperty("objectId"))return r.objectId;if(typeof r._id!="string"&&r._id.$oid)return r._id.$oid};let u=1;t.results.forEach(r=>{const i=l(r);i&&(f[i]=u),u+=1});const d=[];return t.results.forEach(r=>{const i=l(r);i&&(r.id=f[i].toString()),r.pid=f[r.pid],r.rid=f[r.rid],r.status=r.status||"approved";const a={};for(let n=0;n<s.length;n++){const o=s[n];switch(o){case"insertedAt":a[o]=r[o].iso.replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"createdAt":case"updatedAt":a[o]=r[o].replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"rid":case"pid":a[o]=r[o]||null;break;default:a[o]=r[o]||"";break}}d.push(a)}),J.serialize({fields:s.map(r=>({id:r,label:r})),records:d})},q=t=>t.results.map(s=>(s.hasOwnProperty("objectId")?(s._id=s.objectId,delete s.objectId):typeof s._id!="string"&&s._id.$oid&&(s._id=s._id.$oid),typeof s.insertedAt=="object"&&s.insertedAt.iso&&(s.insertedAt={$date:s.insertedAt.iso}),delete s.ACL,JSON.stringify(s))).join(`\r
`),M=t=>{let s;try{s=JSON.parse(t)}catch{s=t.trim().split(/[\r\n]+/).filter(u=>u).map(u=>JSON.parse(u))}return{results:s.map(({_id:l,comment:u,created:d,updated:e,ip:r,link:i,mail:a,nick:n,ua:o,url:c,pid:p,rid:h,isSpam:b})=>({objectId:typeof l=="string"?l:l.$oid,comment:u,insertedAt:{__type:"Date",iso:new Date(d&&d.$numberLong?Number(d.$numberLong):d).toISOString()},createdAt:new Date(d&&d.$numberLong?Number(d.$numberLong):d).toISOString(),updatedAt:new Date(e&&e.$numberLong?Number(e.$numberLong):e).toISOString(),ip:r,link:i,mail:a,nick:n,ua:o,url:c,pid:p,rid:h,status:b?"spam":"approved"}))}},ee={disqus:{wleancloud:L,wcloudbase(t){return q(L(t))},wsql(t){return S(L(t))},wgithub(t){return S(L(t))}},valine:{wleancloud:t=>t,wcloudbase:q,wsql:S,wgithub:S},twikoo:{wleancloud:M,wcloudbase(t){return q(M(t))},wsql(t){return S(M(t))},wgithub(t){return S(M(t))}},artalk:{wleancloud:C,wcloudbase(t){return q(C(t))},wsql(t){return S(C(t))},wgithub(t){return S(C(t))}},commento:{wleancloud:I,wcloudbase(t){return q(I(t))},wsql(t){return S(I(t))},wgithub(t){return S(I(t))}}},O=t=>(B("data-v-ef4721d6"),t=t(),W(),t),te={style:{"margin-bottom":"20px"}},re={class:"input-group"},oe={for:"from"},ne=R('<option value="valine" data-v-ef4721d6>Valine</option><option value="disqus" data-v-ef4721d6>Disqus</option><option value="twikoo" data-v-ef4721d6>Twikoo</option><option value="typecho" data-v-ef4721d6>Typecho</option><option value="artalk" data-v-ef4721d6>Artalk</option><option value="commento" data-v-ef4721d6>Commento</option>',6),ae=[ne],ie={class:"input-group"},se={for:"to"},le=O(()=>g("option",{value:"wleancloud"},"Waline LeanCloud",-1)),ce=O(()=>g("option",{value:"wcloudbase"},"Waline CloudBase",-1)),ue=O(()=>g("option",{value:"wsql"},"Waline MySQL/PostgreSQL/SQLite",-1)),de=O(()=>g("option",{value:"wgithub"},"Github",-1)),pe=[le,ce,ue,de],fe={class:"input-group"},he={key:0,class:"warning custom-block"},me={class:"custom-block-title"},ve=["innerHTML"],ge={key:1,class:"warning custom-block"},be={class:"custom-block-title"},_e=["textContent"],ye={key:2},we=["placeholder"],Se=P({__name:"MigrationTool",setup(t){const s=T("valine"),f=T("wcloudbase"),l=T(""),u=U({"/":{from:"从",to:"迁移至",storage:"存储服务",placeholder:"请将源文件粘贴至此",convert:"转换",title:"友情提示",typeecho:`Typecho 用户可以使用
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine</a
        >
        插件将评论数据导出成 Valine 数据后直接使用。`,tip:"Waline 和 Valine 的 LeanCloud 配置是可以共用的，不需要进行数据转换哦！"},"/en/":{from:"Migrate from",to:"to",storage:"Storage service",placeholder:"Please paste your source file here",convert:"Convert",title:"Tip",typeecho:`Typecho users can use
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine Plugin</a
        >
        to export comment data to Valine format.`,tip:"The LeanCloud configuration of Waline and Valine can be shared, no data conversion is required!"}}),d=e=>{if(e.preventDefault(),!l.value)return alert("请输入内容");s.value==="valine"&&(l.value=l.value.trim(),l.value.match(/},[\r\n]+/)?l.value=JSON.parse(l.value):l.value=JSON.parse(`{"results":[ ${l.value.split(/[\r\n]+/).join(",")} ]}`));const r=ee[s.value][f.value];if(typeof r=="function"){let i=r(l.value);console.log(i),typeof i!="string"&&(i=JSON.stringify(i,null,"	")),X("output."+(f.value!=="wsql"?"json":"csv"),i)}};return(e,r)=>(x(),j("form",null,[g("div",te,[g("div",re,[g("label",oe,A(k(u).from)+" ",1),$(g("select",{id:"from","onUpdate:modelValue":r[0]||(r[0]=i=>s.value=i)},ae,512),[[H,s.value]])]),g("div",ie,[g("label",se," "+A(k(u).to)+" ",1),$(g("select",{id:"to","onUpdate:modelValue":r[1]||(r[1]=i=>f.value=i)},pe,512),[[H,f.value]])]),g("div",fe," "+A(k(u).storage),1)]),s.value==="typecho"?(x(),j("div",he,[g("p",me,A(k(u).tip),1),g("p",{innerHTML:k(u).typeecho},null,8,ve)])):s.value==="valine"&&f.value==="wleancloud"?(x(),j("div",ge,[g("p",be,A(k(u).tip),1),g("p",{textContent:A(k(u).tip)},null,8,_e)])):(x(),j("div",ye,[$(g("textarea",{placeholder:k(u).placeholder,"onUpdate:modelValue":r[2]||(r[2]=i=>l.value=i)},null,8,we),[[Q,l.value]]),g("button",{onClick:d},A(k(u).convert),1)]))]))}}),xe=G(Se,[["__scopeId","data-v-ef4721d6"],["__file","MigrationTool.vue"]]);export{xe as default};
