import{c as F,r as D,X as x,Y as j,$ as m,a4 as A,u as S,a9 as L,ae as $,aa as H,a0 as N,af as z,ag as E,_ as U}from"./framework-44aa3a67.js";import{l as J}from"./app-b467f9f2.js";import{m as P}from"./marked.esm-76161808.js";const R=t=>{const s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(s)},Q=(t,s)=>{const u=window.URL||window.webkitURL||window,l=new Blob([s]),d=document.createElementNS("http://www.w3.org/1999/xhtml","a");d.href=u.createObjectURL(l),d.download=t,R(d)},B=t=>{const s=document.createElement("a");return s.href=t,s.pathname||t},I=t=>{t=JSON.parse(t);const s={},u={};for(let l=0;l<t.length;l++)s[t[l].id]=t[l].rid;for(let l=0;l<t.length;l++){if(!t[l].rid)continue;let d=t[l].rid;for(;s[d];)d=s[d];u[t[l].id]=d}return{results:t.map(({content:l,date:d,email:v,id:e,ip:r,link:i,nick:n,page_key:a,rid:o,ua:c})=>{const p=new Date(d.replace(/-/g,"/")).toISOString(),f=B(a);return{objectId:e,comment:P.parse(l),insertedAt:{__type:"Date",iso:p},mail:v,createdAt:p,updatedAt:p,ip:r,link:i,nick:n,ua:c,url:f,pid:o||null,rid:u[e]||null,status:"approved"}})}},C=t=>{const s=JSON.parse(t),{comments:u}=s,l={},d={},v={};return Array.isArray(s.commenters)&&s.commenters.forEach(e=>{l[e.commenterHex]={nick:e.name,mail:e.email,link:e.link!=="undefined"?e.link:void 0}}),u.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{d[e.commentHex]=e.parentHex}),u.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{let r=e.parentHex;for(;d[r];)r=d[r];v[e.commentHex]=r}),{results:u.filter(({deleted:e})=>!e).map(({commentHex:e,commenterHex:r,parentHex:i,creationDate:n,html:a,markdown:o,url:c,state:p})=>{const f=l[r]||{nick:"Anonymous",mail:"",link:""};return Object.assign({objectId:e,comment:a||o,insertedAt:{__type:"Date",iso:n},createdAt:n,updatedAt:n,ip:"",ua:"",url:c,pid:i!=="root"?i:"",rid:v[e]?v[e]:"",status:p==="approved"?"approved":"waiting"},f)})}},M=t=>{const u=new DOMParser().parseFromString(t,"application/xml"),l=Array.from(u.querySelectorAll("post")).filter(n=>n.querySelector("isDeleted").textContent.toLowerCase()==="false"),d=Array.from(u.querySelectorAll("disqus > thread")),v={};d.forEach(n=>{const a=n.querySelector("link").textContent,o=new URL(a),c=n.getAttribute("dsq:id");v[c]=o.pathname});const e={};l.forEach(n=>{const a=n.getAttribute("dsq:id"),o=n.querySelector("parent");if(o){const c=o.getAttribute("dsq:id");e[a]=c}});const r={};return l.filter(n=>n.querySelector("parent")).forEach(n=>{const a=n.getAttribute("dsq:id");let o=n.querySelector("parent").getAttribute("dsq:id");for(;e[o];)o=e[o];r[a]=o}),{results:l.map(n=>{const a=n.getAttribute("dsq:id"),o=n.querySelector("message").textContent,c=new Date(n.querySelector("createdAt").textContent).toISOString(),p=n.querySelector("author name").textContent,f=n.querySelector("thread").getAttribute("dsq:id"),b=v[f],g=n.querySelector("parent"),h=g?g.getAttribute("dsq:id"):null,k=g?r[a]:null,y=n.querySelector("isSpam").textContent.toLowerCase()!=="false";return{objectId:a,comment:o,insertedAt:{__type:"Date",iso:c},createdAt:c,updatedAt:c,ip:"",link:"",mail:"",nick:p,ua:"",url:b,pid:h,rid:k,status:y?"spam":"approved"}})}};var V={};(function(t){t.__type__="csv";var s=typeof jQuery<"u"&&jQuery.Deferred||typeof _<"u"&&_.Deferred||function(){var e,r,i=new Promise(function(n,a){e=n,r=a});return{resolve:e,reject:r,promise:function(){return i}}};t.fetch=function(e){var r=new s;if(e.file){var i=new FileReader,n=e.encoding||"UTF-8";i.onload=function(o){var c=t.extractFields(t.parse(o.target.result,e),e);c.useMemoryStore=!0,c.metadata={filename:e.file.name},r.resolve(c)},i.onerror=function(o){r.reject({error:{message:"Failed to load file. Code: "+o.target.error.code}})},i.readAsText(e.file,n)}else if(e.data){var a=t.extractFields(t.parse(e.data,e),e);a.useMemoryStore=!0,r.resolve(a)}else e.url&&(window.fetch||function(o){var c=jQuery.get(o),p={then:function(f){return c.done(f),p},catch:function(f){return c.fail(f),p}};return p})(e.url).then(function(o){return o.text?o.text():o}).then(function(o){var c=t.extractFields(t.parse(o,e),e);c.useMemoryStore=!0,r.resolve(c)}).catch(function(o,c){r.reject({error:{message:"Failed to load file. "+o.statusText+". Code: "+o.status,request:o}})});return r.promise()},t.extractFields=function(e,r){return r.noHeaderRow!==!0&&0<e.length?{fields:e[0],records:e.slice(1)}:{records:e}},t.normalizeDialectOptions=function(e){var r={delimiter:",",doublequote:!0,lineterminator:`
`,quotechar:'"',skipinitialspace:!0,skipinitialrows:0};for(var i in e)i==="trim"?r.skipinitialspace=e.trim:r[i.toLowerCase()]=e[i];return r},t.parse=function(e,r){r&&(!r||r.lineterminator)||(e=t.normalizeLineTerminator(e,r));var i,n,a=t.normalizeDialectOptions(r);i=e,n=a.lineterminator,e=i.charAt(i.length-n.length)!==n?i:i.substring(0,i.length-n.length);var o,c,p="",f=!1,b=!1,g="",h=[],k=[];for(c=function(y){return b!==!0&&(y===""?y=null:a.skipinitialspace===!0&&(y=v(y)),u.test(y)?y=parseInt(y,10):l.test(y)&&(y=parseFloat(y,10))),y},o=0;o<e.length;o+=1)p=e.charAt(o),f!==!1||p!==a.delimiter&&p!==a.lineterminator?p!==a.quotechar?g+=p:f?e.charAt(o+1)===a.quotechar?(g+=a.quotechar,o+=1):f=!1:b=f=!0:(g=c(g),h.push(g),p===a.lineterminator&&(k.push(h),h=[]),g="",b=!1);return g=c(g),h.push(g),k.push(h),a.skipinitialrows&&(k=k.slice(a.skipinitialrows)),k},t.normalizeLineTerminator=function(e,r){return(r=r||{}).lineterminator?e:e.replace(/(\r\n|\n|\r)/gm,`
`)},t.objectToArray=function(e){for(var r=[],i=[],n=[],a=0;a<e.fields.length;a++){var o=e.fields[a].id;n.push(o);var c=e.fields[a].label?e.fields[a].label:o;i.push(c)}for(r.push(i),a=0;a<e.records.length;a++){for(var p=[],f=e.records[a],b=0;b<n.length;b++)p.push(f[n[b]]);r.push(p)}return r},t.serialize=function(e,r){var i=null;i=e instanceof Array?e:t.objectToArray(e);var n,a,o,c=t.normalizeDialectOptions(r),p="",f="",b="",g="";for(o=function(h){return h===null?h="":typeof h=="string"&&d.test(h)?(c.doublequote&&(h=h.replace(/"/g,'""')),h=c.quotechar+h+c.quotechar):typeof h=="number"&&(h=h.toString(10)),h},n=0;n<i.length;n+=1)for(p=i[n],a=0;a<p.length;a+=1)f=o(p[a]),a===p.length-1?(g+=(b+=f)+c.lineterminator,b=""):b+=f+c.delimiter,f="";return g};var u=/^\d+$/,l=/^\d*\.\d+$|^\d+\.\d*$/,d=/^\s|\s$|,|"|\n/,v=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}})(V);const w=t=>{const s=["id","nick","updatedAt","mail","ua","ip","status","insertedAt","createdAt","comment","pid","rid","link","url","user_id"],u={},l=r=>{if(r.hasOwnProperty("objectId"))return r.objectId;if(typeof r._id!="string"&&r._id.$oid)return r._id.$oid};let d=1;t.results.forEach(r=>{const i=l(r);i&&(u[i]=d),d+=1});const v=[];return t.results.forEach(r=>{const i=l(r);i&&(r.id=u[i].toString()),r.pid=u[r.pid],r.rid=u[r.rid],r.status=r.status||"approved";const n={};for(let a=0;a<s.length;a++){const o=s[a];switch(o){case"insertedAt":n[o]=r[o].iso.replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"createdAt":case"updatedAt":n[o]=r[o].replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"rid":case"pid":n[o]=r[o]||null;break;default:n[o]=r[o]||"";break}}v.push(n)}),V.serialize({fields:s.map(r=>({id:r,label:r})),records:v})},q=t=>t.results.map(s=>(s.hasOwnProperty("objectId")?(s._id=s.objectId,delete s.objectId):typeof s._id!="string"&&s._id.$oid&&(s._id=s._id.$oid),typeof s.insertedAt=="object"&&s.insertedAt.iso&&(s.insertedAt={$date:s.insertedAt.iso}),delete s.ACL,JSON.stringify(s))).join(`\r
`),T=t=>({results:t.trim().split(/[\r\n]+/).filter(u=>u).map(u=>{const{_id:l,comment:d,created:v,updated:e,ip:r,link:i,mail:n,nick:a,ua:o,url:c,pid:p,rid:f,isSpam:b}=JSON.parse(u);return{objectId:typeof l=="string"?l:l.$oid,comment:d,insertedAt:{__type:"Date",iso:new Date(v).toISOString()},createdAt:new Date(v).toISOString(),updatedAt:new Date(e).toISOString(),ip:r,link:i,mail:n,nick:a,ua:o,url:c,pid:p,rid:f,status:b?"spam":"approved"}})}),W={disqus:{wleancloud:M,wcloudbase(t){return q(M(t))},wsql(t){return w(M(t))},wgithub(t){return w(M(t))}},valine:{wleancloud:t=>t,wcloudbase:q,wsql:w,wgithub:w},twikoo:{wleancloud:T,wcloudbase(t){return q(T(t))},wsql(t){return w(T(t))},wgithub(t){return w(T(t))}},artalk:{wleancloud:I,wcloudbase(t){return q(I(t))},wsql(t){return w(I(t))},wgithub(t){return w(I(t))}},commento:{wleancloud:C,wcloudbase(t){return q(C(t))},wsql(t){return w(C(t))},wgithub(t){return w(C(t))}}},O=t=>(z("data-v-95094897"),t=t(),E(),t),Z={style:{"margin-bottom":"20px"}},G={class:"input-group"},K={for:"from"},X=N('<option value="valine" data-v-95094897>Valine</option><option value="disqus" data-v-95094897>Disqus</option><option value="twikoo" data-v-95094897>Twikoo</option><option value="typecho" data-v-95094897>Typecho</option><option value="artalk" data-v-95094897>Artalk</option><option value="commento" data-v-95094897>Commento</option>',6),Y=[X],ee={class:"input-group"},te={for:"to"},re=O(()=>m("option",{value:"wleancloud"},"Waline LeanCloud",-1)),oe=O(()=>m("option",{value:"wcloudbase"},"Waline CloudBase",-1)),ne=O(()=>m("option",{value:"wsql"},"Waline MySQL/PostgreSQL/SQLite",-1)),ae=O(()=>m("option",{value:"wgithub"},"Github",-1)),ie=[re,oe,ne,ae],se={class:"input-group"},le={key:0,class:"warning custom-block"},ce={class:"custom-block-title"},de=["innerHTML"],ue={key:1,class:"warning custom-block"},pe={class:"custom-block-title"},fe=["textContent"],he={key:2},ve=["placeholder"],me=F({__name:"MigrationTool",setup(t){const s=D("valine"),u=D("wcloudbase"),l=D(""),d=J({"/":{from:"从",to:"迁移至",storage:"存储服务",placeholder:"请将源文件粘贴至此",convert:"转换",title:"友情提示",typeecho:`Typecho 用户可以使用
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine</a
        >
        插件将评论数据导出成 Valine 数据后直接使用。`,tip:"Waline 和 Valine 的 LeanCloud 配置是可以共用的，不需要进行数据转换哦！"},"/en/":{from:"Migrate from",to:"to",storage:"Storage service",placeholder:"Please paste your source file here",convert:"Convert",title:"Tip",typeecho:`Typecho users can use
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine Plugin</a
        >
        to export comment data to Valine format.`,tip:"The LeanCloud configuration of Waline and Valine can be shared, no data conversion is required!"}}),v=e=>{if(e.preventDefault(),!l.value)return alert("请输入内容");s.value==="valine"&&(l.value=l.value.trim(),l.value.match(/},[\r\n]+/)?l.value=JSON.parse(l.value):l.value=JSON.parse(`{"results":[ ${l.value.split(/[\r\n]+/).join(",")} ]}`));const r=W[s.value][u.value];if(typeof r=="function"){let i=r(l.value);console.log(i),typeof i!="string"&&(i=JSON.stringify(i,null,"	")),Q("output."+(u.value!=="wsql"?"json":"csv"),i)}};return(e,r)=>(x(),j("form",null,[m("div",Z,[m("div",G,[m("label",K,A(S(d).from)+" ",1),L(m("select",{id:"from","onUpdate:modelValue":r[0]||(r[0]=i=>s.value=i)},Y,512),[[$,s.value]])]),m("div",ee,[m("label",te," "+A(S(d).to)+" ",1),L(m("select",{id:"to","onUpdate:modelValue":r[1]||(r[1]=i=>u.value=i)},ie,512),[[$,u.value]])]),m("div",se," "+A(S(d).storage),1)]),s.value==="typecho"?(x(),j("div",le,[m("p",ce,A(S(d).tip),1),m("p",{innerHTML:S(d).typeecho},null,8,de)])):s.value==="valine"&&u.value==="wleancloud"?(x(),j("div",ue,[m("p",pe,A(S(d).tip),1),m("p",{textContent:A(S(d).tip)},null,8,fe)])):(x(),j("div",he,[L(m("textarea",{placeholder:S(d).placeholder,"onUpdate:modelValue":r[2]||(r[2]=i=>l.value=i)},null,8,ve),[[H,l.value]]),m("button",{onClick:v},A(S(d).convert),1)]))]))}});const ye=U(me,[["__scopeId","data-v-95094897"],["__file","MigrationTool.vue"]]);export{ye as default};
