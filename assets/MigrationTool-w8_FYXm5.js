import{bE as P,aO as R,f as U,aN as M,o as x,c as q,d as g,aV as A,b3 as T,bF as z,b5 as Q,b as B,bG as W,bH as $}from"./app-B_eCFwn4.js";import{m as G}from"./marked.esm-B66Z6oAV.js";import{_ as Z}from"./plugin-vue_export-helper-DlAUqK2U.js";const K=t=>{const s=P();return R(()=>t[s.value]??{})},X=t=>{const s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(s)},Y=(t,s)=>{const f=window.URL||window.webkitURL||window,i=document.createElementNS("http://www.w3.org/1999/xhtml","a");i.href=f.createObjectURL(new Blob([s])),i.download=t,X(i)},ee=t=>{const s=document.createElement("a");return s.href=t,s.pathname||t},L=t=>{t=JSON.parse(t);const s={},f={};for(let i=0;i<t.length;i++)s[t[i].id]=t[i].rid;for(let i=0;i<t.length;i++){if(!t[i].rid)continue;let d=t[i].rid;for(;s[d];)d=s[d];f[t[i].id]=d}return{results:t.map(({content:i,date:d,created_at:u,email:e,id:r,ip:c,link:a,nick:o,page_key:n,rid:l,ua:p,is_pinned:h,is_pending:b,vote_down:v,vote_up:m})=>{const w=d||u?new Date((d||u).replace(/-/g,"/")).toISOString():"",y=ee(n);return{objectId:r,comment:G.parse(i),insertedAt:{__type:"Date",iso:w},mail:e,createdAt:w,updatedAt:w,ip:c,link:a,nick:o,ua:p,url:y,pid:l||null,rid:f[r]||null,status:b!=="false"?"waiting":"approved",sticky:h==="true",like:m&&v?m-v:0}})}},j=t=>{const s=JSON.parse(t),{comments:f}=s,i={},d={},u={};return Array.isArray(s.commenters)&&s.commenters.forEach(e=>{i[e.commenterHex]={nick:e.name,mail:e.email,link:e.link!=="undefined"?e.link:void 0}}),f.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{d[e.commentHex]=e.parentHex}),f.filter(e=>e.parentHex&&e.parentHex!=="root").forEach(e=>{let r=e.parentHex;for(;d[r];)r=d[r];u[e.commentHex]=r}),{results:f.filter(({deleted:e})=>!e).map(({commentHex:e,commenterHex:r,parentHex:c,creationDate:a,html:o,markdown:n,url:l,state:p})=>{const h=i[r]||{nick:"Anonymous",mail:"",link:""};return Object.assign({objectId:e,comment:o||n,insertedAt:{__type:"Date",iso:a},createdAt:a,updatedAt:a,ip:"",ua:"",url:l,pid:c!=="root"?c:"",rid:u[e]?u[e]:"",status:p==="approved"?"approved":"waiting"},h)})}},C=t=>{const f=new DOMParser().parseFromString(t,"application/xml"),i=Array.from(f.querySelectorAll("post")).filter(a=>{var n;const o=a.querySelector("isDeleted");return!(o&&((n=o.textContent)==null?void 0:n.toLocaleLowerCase())==="true")}),d=Array.from(f.querySelectorAll("disqus > thread")),u={};d.forEach(a=>{const o=a.querySelector("link"),n=a.getAttribute("dsq:id");if(u[n]="",o&&o.textContent){const l=new URL(o.textContent);u[n]=l.pathname}});const e={};i.forEach(a=>{const o=a.getAttribute("dsq:id"),n=a.querySelector("parent");if(n){const l=n.getAttribute("dsq:id");if(!l)return;e[o]=l}});const r={};return i.filter(a=>a.querySelector("parent")).forEach(a=>{var l;const o=a.getAttribute("dsq:id");let n=(l=a.querySelector("parent"))==null?void 0:l.getAttribute("dsq:id");for(;e[n];)n=e[n];r[o]=n}),{results:i.map(a=>{var D,N,V,E,F,H;const o=a.getAttribute("dsq:id"),n=(D=a.querySelector("message"))==null?void 0:D.textContent,l=new Date((N=a.querySelector("createdAt"))==null?void 0:N.textContent).toISOString(),p=(V=a.querySelector("author name"))==null?void 0:V.textContent,h=(E=a.querySelector("thread"))==null?void 0:E.getAttribute("dsq:id"),b=u[h],v=a.querySelector("parent"),m=v?v.getAttribute("dsq:id"):null,w=v?r[o]:null,y=((H=(F=a.querySelector("isSpam"))==null?void 0:F.textContent)==null?void 0:H.toLowerCase())!=="false";return{objectId:o,comment:n,insertedAt:{__type:"Date",iso:l},createdAt:l,updatedAt:l,ip:"",link:"",mail:"",nick:p,ua:"",url:b,pid:m,rid:w,status:y?"spam":"approved"}})}};var J={};(function(t){t.__type__="csv";var s=typeof jQuery<"u"&&jQuery.Deferred||typeof _<"u"&&_.Deferred||function(){var e,r,c=new Promise(function(a,o){e=a,r=o});return{resolve:e,reject:r,promise:function(){return c}}};t.fetch=function(e){var r=new s;if(e.file){var c=new FileReader,a=e.encoding||"UTF-8";c.onload=function(n){var l=t.extractFields(t.parse(n.target.result,e),e);l.useMemoryStore=!0,l.metadata={filename:e.file.name},r.resolve(l)},c.onerror=function(n){r.reject({error:{message:"Failed to load file. Code: "+n.target.error.code}})},c.readAsText(e.file,a)}else if(e.data){var o=t.extractFields(t.parse(e.data,e),e);o.useMemoryStore=!0,r.resolve(o)}else e.url&&(window.fetch||function(n){var l=jQuery.get(n),p={then:function(h){return l.done(h),p},catch:function(h){return l.fail(h),p}};return p})(e.url).then(function(n){return n.text?n.text():n}).then(function(n){var l=t.extractFields(t.parse(n,e),e);l.useMemoryStore=!0,r.resolve(l)}).catch(function(n,l){r.reject({error:{message:"Failed to load file. "+n.statusText+". Code: "+n.status,request:n}})});return r.promise()},t.extractFields=function(e,r){return r.noHeaderRow!==!0&&0<e.length?{fields:e[0],records:e.slice(1)}:{records:e}},t.normalizeDialectOptions=function(e){var r={delimiter:",",doublequote:!0,lineterminator:`
`,quotechar:'"',skipinitialspace:!0,skipinitialrows:0};for(var c in e)c==="trim"?r.skipinitialspace=e.trim:r[c.toLowerCase()]=e[c];return r},t.parse=function(e,r){r&&(!r||r.lineterminator)||(e=t.normalizeLineTerminator(e,r));var c,a,o=t.normalizeDialectOptions(r);c=e,a=o.lineterminator,e=c.charAt(c.length-a.length)!==a?c:c.substring(0,c.length-a.length);var n,l,p="",h=!1,b=!1,v="",m=[],w=[];for(l=function(y){return b!==!0&&(y===""?y=null:o.skipinitialspace===!0&&(y=u(y)),f.test(y)?y=parseInt(y,10):i.test(y)&&(y=parseFloat(y,10))),y},n=0;n<e.length;n+=1)p=e.charAt(n),h!==!1||p!==o.delimiter&&p!==o.lineterminator?p!==o.quotechar?v+=p:h?e.charAt(n+1)===o.quotechar?(v+=o.quotechar,n+=1):h=!1:b=h=!0:(v=l(v),m.push(v),p===o.lineterminator&&(w.push(m),m=[]),v="",b=!1);return v=l(v),m.push(v),w.push(m),o.skipinitialrows&&(w=w.slice(o.skipinitialrows)),w},t.normalizeLineTerminator=function(e,r){return(r=r||{}).lineterminator?e:e.replace(/(\r\n|\n|\r)/gm,`
`)},t.objectToArray=function(e){for(var r=[],c=[],a=[],o=0;o<e.fields.length;o++){var n=e.fields[o].id;a.push(n);var l=e.fields[o].label?e.fields[o].label:n;c.push(l)}for(r.push(c),o=0;o<e.records.length;o++){for(var p=[],h=e.records[o],b=0;b<a.length;b++)p.push(h[a[b]]);r.push(p)}return r},t.serialize=function(e,r){var c=null;c=e instanceof Array?e:t.objectToArray(e);var a,o,n,l=t.normalizeDialectOptions(r),p="",h="",b="",v="";for(n=function(m){return m===null?m="":typeof m=="string"&&d.test(m)?(l.doublequote&&(m=m.replace(/"/g,'""')),m=l.quotechar+m+l.quotechar):typeof m=="number"&&(m=m.toString(10)),m},a=0;a<c.length;a+=1)for(p=c[a],o=0;o<p.length;o+=1)h=n(p[o]),o===p.length-1?(v+=(b+=h)+l.lineterminator,b=""):b+=h+l.delimiter,h="";return v};var f=/^\d+$/,i=/^\d*\.\d+$|^\d+\.\d*$/,d=/^\s|\s$|,|"|\n/,u=String.prototype.trim?function(e){return e.trim()}:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}})(J);const S=t=>{const s=["id","nick","updatedAt","mail","ua","ip","status","insertedAt","createdAt","comment","pid","rid","link","url","user_id"],f={},i=r=>{if(r.hasOwnProperty("objectId"))return r.objectId;if(typeof r._id!="string"&&r._id.$oid)return r._id.$oid};let d=1;t.results.forEach(r=>{const c=i(r);c&&(f[c]=d),d+=1});const u=[];return t.results.forEach(r=>{const c=i(r);c&&(r.id=f[c].toString()),r.pid=f[r.pid],r.rid=f[r.rid],r.status=r.status||"approved";const a={};for(let o=0;o<s.length;o++){const n=s[o];switch(n){case"insertedAt":a[n]=r[n].iso.replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"createdAt":case"updatedAt":a[n]=r[n].replace("T"," ").replace(/.\d{3}Z$/i,"");break;case"rid":case"pid":a[n]=r[n]||null;break;default:a[n]=r[n]||"";break}}u.push(a)}),J.serialize({fields:s.map(r=>({id:r,label:r})),records:u})},k=t=>t.results.map(s=>(s.hasOwnProperty("objectId")?(s._id=s.objectId,delete s.objectId):typeof s._id!="string"&&s._id.$oid&&(s._id=s._id.$oid),typeof s.insertedAt=="object"&&s.insertedAt.iso&&(s.insertedAt={$date:s.insertedAt.iso}),delete s.ACL,JSON.stringify(s))).join(`\r
`),I=t=>{let s;try{s=JSON.parse(t)}catch{s=t.trim().split(/[\r\n]+/).filter(d=>d).map(d=>JSON.parse(d))}return{results:s.map(({_id:i,comment:d,created:u,updated:e,ip:r,link:c,mail:a,nick:o,ua:n,url:l,pid:p,rid:h,isSpam:b})=>({objectId:typeof i=="string"?i:i.$oid,comment:d,insertedAt:{__type:"Date",iso:new Date(u!=null&&u.$numberLong?Number(u.$numberLong):u).toISOString()},createdAt:new Date(u!=null&&u.$numberLong?Number(u.$numberLong):u).toISOString(),updatedAt:new Date(e!=null&&e.$numberLong?Number(e.$numberLong):e).toISOString(),ip:r,link:c,mail:a,nick:o,ua:n,url:l,pid:p,rid:h,status:b?"spam":"approved"}))}},te={disqus:{wleancloud:C,wcloudbase(t){return k(C(t))},wsql(t){return S(C(t))},wgithub(t){return S(C(t))}},valine:{wleancloud:t=>t,wcloudbase:k,wsql:S,wgithub:S},twikoo:{wleancloud:I,wcloudbase(t){return k(I(t))},wsql(t){return S(I(t))},wgithub(t){return S(I(t))}},artalk:{wleancloud:L,wcloudbase(t){return k(L(t))},wsql(t){return S(L(t))},wgithub(t){return S(L(t))}},commento:{wleancloud:j,wcloudbase(t){return k(j(t))},wsql(t){return S(j(t))},wgithub(t){return S(j(t))}}},re=U({__name:"MigrationTool",setup(t,{expose:s}){s();const f=M("valine"),i=M("wcloudbase"),d=M(""),u=K({"/":{from:"从",to:"迁移至",storage:"存储服务",placeholder:"请将源文件粘贴至此",convert:"转换",title:"友情提示",typeecho:`Typecho 用户可以使用
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine</a
        >
        插件将评论数据导出成 Valine 数据后直接使用。`,tip:"Waline 和 Valine 的 LeanCloud 配置是可以共用的，不需要进行数据转换哦！"},"/en/":{from:"Migrate from",to:"to",storage:"Storage service",placeholder:"Please paste your source file here",convert:"Convert",title:"Tip",typeecho:`Typecho users can use
        <a
          href="https://github.com/lizheming/typecho-export-valine"
          target="_blank"
          >Export2Valine Plugin</a
        >
        to export comment data to Valine format.`,tip:"The LeanCloud configuration of Waline and Valine can be shared, no data conversion is required!"}}),r={from:f,to:i,source:d,i18n:u,click:c=>{if(c.preventDefault(),!d.value)return alert("请输入内容");f.value==="valine"&&(d.value=d.value.trim(),d.value.match(/},[\r\n]+/)?d.value=JSON.parse(d.value):d.value=JSON.parse(`{"results":[ ${d.value.split(/[\r\n]+/).join(",")} ]}`));const a=te[f.value][i.value];if(typeof a=="function"){let o=a(d.value);console.log(o),typeof o!="string"&&(o=JSON.stringify(o,null,"	")),Y("output."+(i.value!=="wsql"?"json":"csv"),o)}}};return Object.defineProperty(r,"__isScriptSetup",{enumerable:!1,value:!0}),r}}),O=t=>(W("data-v-a7066e67"),t=t(),$(),t),oe={style:{"margin-bottom":"20px"}},ne={class:"input-group"},ie={for:"from"},ae=B('<option value="valine" data-v-a7066e67>Valine</option><option value="disqus" data-v-a7066e67>Disqus</option><option value="twikoo" data-v-a7066e67>Twikoo</option><option value="typecho" data-v-a7066e67>Typecho</option><option value="artalk" data-v-a7066e67>Artalk</option><option value="commento" data-v-a7066e67>Commento</option>',6),se=[ae],le={class:"input-group"},ce={for:"to"},de=O(()=>g("option",{value:"wleancloud"},"Waline LeanCloud",-1)),ue=O(()=>g("option",{value:"wcloudbase"},"Waline CloudBase",-1)),pe=O(()=>g("option",{value:"wsql"},"Waline MySQL/PostgreSQL/SQLite",-1)),fe=O(()=>g("option",{value:"wgithub"},"Github",-1)),he=[de,ue,pe,fe],me={class:"input-group"},ve={key:0,class:"custom-block warning"},ge={class:"custom-block-title"},be=["innerHTML"],_e={key:1,class:"custom-block warning"},ye={class:"custom-block-title"},we=["textContent"],Se={key:2},Ae=["placeholder"];function ke(t,s,f,i,d,u){return x(),q("form",null,[g("div",oe,[g("div",ne,[g("label",ie,A(i.i18n.from)+" ",1),T(g("select",{id:"from","onUpdate:modelValue":s[0]||(s[0]=e=>i.from=e)},se,512),[[z,i.from]])]),g("div",le,[g("label",ce," "+A(i.i18n.to)+" ",1),T(g("select",{id:"to","onUpdate:modelValue":s[1]||(s[1]=e=>i.to=e)},he,512),[[z,i.to]])]),g("div",me," "+A(i.i18n.storage),1)]),i.from==="typecho"?(x(),q("div",ve,[g("p",ge,A(i.i18n.tip),1),g("p",{innerHTML:i.i18n.typeecho},null,8,be)])):i.from==="valine"&&i.to==="wleancloud"?(x(),q("div",_e,[g("p",ye,A(i.i18n.tip),1),g("p",{textContent:A(i.i18n.tip)},null,8,we)])):(x(),q("div",Se,[T(g("textarea",{"onUpdate:modelValue":s[2]||(s[2]=e=>i.source=e),placeholder:i.i18n.placeholder},null,8,Ae),[[Q,i.source]]),g("button",{onClick:i.click},A(i.i18n.convert),1)]))])}const je=Z(re,[["render",ke],["__scopeId","data-v-a7066e67"],["__file","MigrationTool.vue"]]);export{je as default};
